STUN & TURN & ICE
1. STUNï¼ˆSession Traversal Utilities for NATï¼‰ï¼š
  - STUNæœåŠ¡å™¨å¸®åŠ©å®¢æˆ·ç«¯å‘ç°å…¶å…¬å…±IPåœ°å€å’Œç«¯å£å·ï¼Œä»è€Œä½¿å…¶èƒ½å¤Ÿä¸ä½äºä¸åŒç½‘ç»œä¸­çš„å…¶ä»–å®¢æˆ·ç«¯è¿›è¡Œç›´æ¥é€šä¿¡ã€‚
  - å·¥ä½œåŸç†ï¼šå®¢æˆ·ç«¯å‘STUNæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒSTUNæœåŠ¡å™¨è¿”å›å®¢æˆ·ç«¯çš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ä¸å…¶ä»–å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ã€‚
2. TURNï¼ˆTraversal Using Relays around NATï¼‰ï¼š
  - TURNæœåŠ¡å™¨å……å½“ä¸­ç»§æœåŠ¡å™¨ï¼Œå¸®åŠ©å®¢æˆ·ç«¯åœ¨æ— æ³•ç›´æ¥å»ºç«‹ç‚¹å¯¹ç‚¹è¿æ¥æ—¶è¿›è¡Œé€šä¿¡ã€‚
  - å·¥ä½œåŸç†ï¼šå®¢æˆ·ç«¯å‘TURNæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè¦æ±‚ä¸­ç»§å…¶æ•°æ®ã€‚TURNæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œè½¬å‘å®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ã€‚
3. ICEï¼ˆInteractive Connectivity Establishmentï¼‰ï¼š
  - ICEæ˜¯ä¸€ç§æ¡†æ¶ï¼Œç»“åˆä½¿ç”¨STUNå’ŒTURNæ¥æ‰¾åˆ°æœ€ä½³çš„è¿æ¥è·¯å¾„ã€‚
  - å·¥ä½œåŸç†ï¼šå®¢æˆ·ç«¯æ”¶é›†å¤šä¸ªå€™é€‰è¿æ¥ï¼ˆåŒ…æ‹¬ç›´æ¥è¿æ¥å’Œé€šè¿‡TURNæœåŠ¡å™¨çš„ä¸­ç»§è¿æ¥ï¼‰ï¼Œå¹¶å°è¯•ä½¿ç”¨è¿™äº›å€™é€‰è¿æ¥è¿›è¡Œé€šä¿¡ã€‚ICEé€‰æ‹©æœ€ä¼˜çš„è¿æ¥è·¯å¾„ã€‚
NATç±»å‹
- å…¨é”¥å½¢NATï¼ˆFull Cone NATï¼‰ï¼šä»»ä½•å¤–éƒ¨ä¸»æœºéƒ½å¯ä»¥é€šè¿‡NATè®¾å¤‡çš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ä¸å†…éƒ¨ä¸»æœºé€šä¿¡ã€‚
- å—é™é”¥å½¢NATï¼ˆRestricted Cone NATï¼‰ï¼šåªæœ‰å†…éƒ¨ä¸»æœºä¹‹å‰é€šä¿¡è¿‡çš„å¤–éƒ¨ä¸»æœºæ‰èƒ½é€šè¿‡NATè®¾å¤‡çš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ä¸å†…éƒ¨ä¸»æœºé€šä¿¡ã€‚
- ç«¯å£å—é™é”¥å½¢NATï¼ˆPort Restricted Cone NATï¼‰ï¼šåªæœ‰å†…éƒ¨ä¸»æœºä¹‹å‰é€šä¿¡è¿‡çš„å¤–éƒ¨ä¸»æœºï¼Œå¹¶ä¸”ä½¿ç”¨ç›¸åŒç«¯å£å·ï¼Œæ‰èƒ½é€šè¿‡NATè®¾å¤‡çš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ä¸å†…éƒ¨ä¸»æœºé€šä¿¡ã€‚
- å¯¹ç§°NATï¼ˆSymmetric NATï¼‰ï¼šæ¯ä¸ªå†…éƒ¨ä¸»æœºä¸å¤–éƒ¨ä¸»æœºçš„é€šä¿¡ä¼šä½¿ç”¨ä¸åŒçš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ï¼Œåªæœ‰ç‰¹å®šçš„å¤–éƒ¨ä¸»æœºæ‰èƒ½ä¸å†…éƒ¨ä¸»æœºé€šä¿¡ã€‚
NAT å¯¹ P2Pçš„å½±å“
- åœ°å€è½¬æ¢ï¼šNATè®¾å¤‡ä¼šéšè—å†…éƒ¨ç½‘ç»œçš„ç§æœ‰IPåœ°å€ï¼Œä½¿å¾—å¤–éƒ¨ä¸»æœºæ— æ³•ç›´æ¥ä¸å†…éƒ¨ä¸»æœºé€šä¿¡ã€‚
- ç«¯å£æ˜ å°„ï¼šNATè®¾å¤‡ä¼šåŠ¨æ€åˆ†é…ç«¯å£å·ï¼Œä½¿å¾—å¤–éƒ¨ä¸»æœºæ— æ³•ç¡®å®šå†…éƒ¨ä¸»æœºçš„å®é™…ç«¯å£å·ã€‚
- å¯¹ç§°NATï¼šå¯¹ç§°NATç±»å‹å°¤å…¶éš¾ä»¥ç©¿è¶Šï¼Œå› ä¸ºæ¯ä¸ªè¿æ¥ä½¿ç”¨ä¸åŒçš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ã€‚

é˜²ç«å¢™
é˜²ç«å¢™å¯¹P2Pè¿æ¥çš„å½±å“ï¼š
- é˜»æ­¢å…¥ç«™è¿æ¥ï¼šé˜²ç«å¢™é€šå¸¸ä¼šé˜»æ­¢æœªç»æˆæƒçš„å…¥ç«™è¿æ¥ï¼Œå¯¼è‡´å¤–éƒ¨ä¸»æœºæ— æ³•ç›´æ¥ä¸å†…éƒ¨ä¸»æœºé€šä¿¡ã€‚
- ç«¯å£å°é”ï¼šé˜²ç«å¢™å¯èƒ½ä¼šå°é”ç‰¹å®šç«¯å£ï¼Œé˜»æ­¢P2Påº”ç”¨ç¨‹åºä½¿ç”¨è¿™äº›ç«¯å£è¿›è¡Œé€šä¿¡ã€‚
- åè®®é™åˆ¶ï¼šé˜²ç«å¢™å¯èƒ½ä¼šé™åˆ¶ç‰¹å®šåè®®ï¼ˆå¦‚UDPï¼‰ï¼Œè€ŒP2Påº”ç”¨ç¨‹åºé€šå¸¸ä¾èµ–è¿™äº›åè®®è¿›è¡Œé€šä¿¡ã€‚

STUNçš„å·¥ä½œåŸç†
STUNçš„å·¥ä½œåŸç†
STUNåè®®çš„å·¥ä½œåŸç†åŸºäºå®¢æˆ·ç«¯å‘STUNæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒSTUNæœåŠ¡å™¨è¿”å›å®¢æˆ·ç«¯çš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š
1. å®¢æˆ·ç«¯å‘é€STUNè¯·æ±‚ï¼š
  - å®¢æˆ·ç«¯å‘STUNæœåŠ¡å™¨å‘é€ä¸€ä¸ªSTUNè¯·æ±‚æ¶ˆæ¯ã€‚è¿™ä¸ªè¯·æ±‚é€šå¸¸æ˜¯é€šè¿‡UDPåè®®å‘é€çš„ï¼Œå› ä¸ºUDPæ˜¯æ— è¿æ¥çš„ï¼Œé€‚åˆè¿™ç§ç®€å•çš„è¯·æ±‚-å“åº”æ¨¡å¼ã€‚
  - è¯·æ±‚æ¶ˆæ¯åŒ…å«å®¢æˆ·ç«¯çš„æœ¬åœ°IPåœ°å€å’Œç«¯å£å·ã€‚
2. STUNæœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ï¼š
  - STUNæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šè®°å½•ä¸‹è¯·æ±‚çš„æºIPåœ°å€å’Œç«¯å£å·ã€‚è¿™äº›ä¿¡æ¯æ˜¯å®¢æˆ·ç«¯åœ¨NATè®¾å¤‡åçš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ã€‚
3. STUNæœåŠ¡å™¨å‘é€å“åº”ï¼š
  - STUNæœåŠ¡å™¨å°†è®°å½•çš„æºIPåœ°å€å’Œç«¯å£å·å°è£…åœ¨å“åº”æ¶ˆæ¯ä¸­ï¼Œå¹¶å‘é€å›å®¢æˆ·ç«¯ã€‚
  - å“åº”æ¶ˆæ¯åŒ…å«å®¢æˆ·ç«¯çš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ã€‚
4. å®¢æˆ·ç«¯æ¥æ”¶å“åº”ï¼š
  - å®¢æˆ·ç«¯æ¥æ”¶åˆ°STUNæœåŠ¡å™¨çš„å“åº”æ¶ˆæ¯åï¼Œä»ä¸­æå–å‡ºå…¬å…±IPåœ°å€å’Œç«¯å£å·ã€‚
  - å®¢æˆ·ç«¯ç°åœ¨çŸ¥é“äº†å…¶åœ¨NATè®¾å¤‡åçš„å…¬å…±ç½‘ç»œåœ°å€ï¼Œå¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯ä¸å…¶ä»–å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ã€‚

STUNçš„è¯·æ±‚å’Œå“åº”ç¤ºä¾‹
ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„STUNè¯·æ±‚å’Œå“åº”ç¤ºä¾‹ï¼š
STUNè¯·æ±‚ï¼š
å¤åˆ¶ä»£ç 
Client -> STUN Server: STUN Request (from local IP: 192.168.1.2, local port: 54321)
STUNå“åº”ï¼š
å¤åˆ¶ä»£ç 
STUN Server -> Client: STUN Response (public IP: 203.0.113.5, public port: 12345)
åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå®¢æˆ·ç«¯çš„æœ¬åœ°IPåœ°å€æ˜¯192.168.1.2ï¼Œæœ¬åœ°ç«¯å£å·æ˜¯54321ã€‚STUNæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œè®°å½•ä¸‹è¯·æ±‚çš„æºIPåœ°å€203.0.113.5å’Œç«¯å£å·12345ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

ä¼˜åŠ¿ï¼š
1. ç®€å•é«˜æ•ˆï¼šSTUNåè®®éå¸¸ç®€å•ï¼Œåªéœ€è¦å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æ¥æ”¶ä¸€ä¸ªå“åº”å³å¯å®Œæˆå…¬å…±IPåœ°å€å’Œç«¯å£å·çš„å‘ç°ã€‚
2. ä½å»¶è¿Ÿï¼šç”±äºSTUNä½¿ç”¨UDPåè®®ï¼Œé€šä¿¡å»¶è¿Ÿè¾ƒä½ï¼Œé€‚åˆå®æ—¶åº”ç”¨ã€‚
3. å¹¿æ³›æ”¯æŒï¼šSTUNåè®®è¢«å¹¿æ³›æ”¯æŒï¼Œè®¸å¤šå®æ—¶é€šä¿¡åº”ç”¨ï¼ˆå¦‚WebRTCï¼‰éƒ½ä½¿ç”¨STUNæ¥å®ç°NATç©¿è¶Šã€‚
å±€é™æ€§ï¼š
1. å¯¹ç§°NATçš„é™åˆ¶ï¼šSTUNåœ¨å¯¹ç§°NATç¯å¢ƒä¸­æ•ˆæœä¸ä½³ã€‚å¯¹ç§°NATä¼šä¸ºæ¯ä¸ªå¤–éƒ¨è¿æ¥åˆ†é…ä¸åŒçš„å…¬å…±IPåœ°å€å’Œç«¯å£å·ï¼Œä½¿å¾—STUNæ— æ³•å‡†ç¡®å‘ç°å…¬å…±ç½‘ç»œåœ°å€ã€‚
2. é˜²ç«å¢™çš„é™åˆ¶ï¼šæŸäº›é˜²ç«å¢™å¯èƒ½ä¼šé˜»æ­¢STUNè¯·æ±‚ï¼Œå¯¼è‡´STUNæ— æ³•æ­£å¸¸å·¥ä½œã€‚

SDP
- https://segmentfault.com/a/1190000041614675
SDPï¼ˆSession Description Protocolï¼‰æŒ‡ä¼šè¯æè¿°åè®®ï¼Œæ˜¯ä¸€ç§é€šç”¨çš„åè®®ï¼ŒåŸºäºæ–‡æœ¬ï¼Œå…¶æœ¬èº«å¹¶ä¸å±äºä¼ è¾“åè®®ï¼Œéœ€è¦ä¾èµ–å…¶å®ƒçš„ä¼ è¾“åè®®ï¼ˆå¦‚ RTP äº¤æ¢åª’ä½“ä¿¡æ¯ã€‚
SDP ä¸»è¦ç”¨æ¥æè¿°å¤šåª’ä½“ä¼šè¯ï¼Œç”¨é€”åŒ…æ‹¬ä¼šè¯å£°æ˜ã€ä¼šè¯é‚€è¯·ã€ä¼šè¯åˆå§‹åŒ–ç­‰ã€‚é€šä¿—æ¥è®²ï¼Œå®ƒå¯ä»¥è¡¨ç¤ºå„ç«¯çš„èƒ½åŠ›ï¼Œè®°å½•æœ‰å…³äºä½ éŸ³é¢‘ç¼–è§£ç ç±»å‹ã€ç¼–è§£ç å™¨ç›¸å…³çš„å‚æ•°ã€ä¼ è¾“åè®®ç­‰ä¿¡æ¯ã€‚
äº¤æ¢ SDP æ—¶ï¼Œé€šä¿¡çš„åŒæ–¹ä¼šå°†æ¥å—åˆ°çš„ SDP å’Œè‡ªå·±çš„ SDP è¿›è¡Œæ¯”è¾ƒï¼Œå–å‡ºä»–ä»¬ä¹‹é—´çš„äº¤é›†ï¼Œè¿™ä¸ªäº¤é›†å°±æ˜¯åå•†çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆåŒæ–¹éŸ³è§†é¢‘é€šä¿¡æ—¶ä½¿ç”¨çš„éŸ³è§†é¢‘å‚æ•°åŠä¼ è¾“åè®®ã€‚

- å‘èµ·ç«¯å‘é€çš„ SDP æ¶ˆæ¯ç§°ä¸º Offerï¼Œæ¥æ”¶ç«¯å‘é€çš„ SDP æ¶ˆæ¯ç§°ä¸º Answer

ä¿¡ä»¤ä¸ä¿¡ä»¤æœåŠ¡å™¨
[å›¾ç‰‡]
- å‘èµ·ç«¯å‘é€ Offer SDP å’Œæ¥æ”¶ç«¯æ¥å— Answer SDPï¼Œè¦æ€ä¹ˆå‘ç»™å¯¹æ–¹å‘¢ï¼Ÿè¿™ä¸ªè¿‡ç¨‹è¿˜éœ€è¦ä¸€ç§æœºåˆ¶æ¥åè°ƒé€šä¿¡å¹¶å‘é€æ§åˆ¶æ¶ˆæ¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç§°ä¸ºä¿¡ä»¤ã€‚
ä¿¡ä»¤æœåŠ¡å™¨
ä¿¡ä»¤å¯¹åº”çš„æœåŠ¡å™¨å°±å«ä¿¡ä»¤æœåŠ¡å™¨ï¼Œä½œä¸ºä¸­é—´äººå¸®åŠ©å»ºç«‹è¿æ¥
1. äº¤æ¢ SDPï¼šSDP åŒ…å«äº†å¯¹ç­‰ç«¯çš„åª’ä½“èƒ½åŠ›ï¼ˆå¦‚ç¼–è§£ç å™¨ã€åˆ†è¾¨ç‡ç­‰ï¼‰å’Œç½‘ç»œä¿¡æ¯ã€‚ï¼š
  1. ä¿¡ä»¤çš„å¤„ç†ï¼Œå¦‚åª’ä½“åå•†æ¶ˆæ¯çš„ä¼ é€’
2. äº¤æ¢ ICE å€™é€‰è€…ï¼šICE å€™é€‰è€…åŒ…å«äº†å¯¹ç­‰ç«¯çš„æ½œåœ¨è¿æ¥åœ°å€ï¼ˆå¦‚æœ¬åœ° IPã€å…¬ç½‘ IPã€é€šè¿‡ STUN è·å–çš„ IP ç­‰ï¼‰ã€‚
  1. ç®¡ç†æˆ¿é—´ä¿¡æ¯ã€‚æ¯”å¦‚ç”¨æˆ·è¿æ¥æ—¶å‘Šè¯‰ä¿¡ä»¤æœåŠ¡å™¨è‡ªèº«çš„æˆ¿é—´å·ï¼Œç”±ä¿¡ä»¤æœåŠ¡å™¨æ‰¾åˆ°ä¹Ÿåœ¨è¯¥æˆ¿é—´å·çš„å¯¹ç­‰ç«¯å¹¶å¼€å§‹å°è¯•é€šä¿¡ï¼Œä¹Ÿé€šçŸ¥ç”¨æˆ·è°åŠ å…¥äº†æˆ¿é—´å’Œç¦»å¼€äº†æˆ¿é—´ï¼Œé€šçŸ¥æˆ¿é—´äººæ•°æ˜¯å¦å·²æ»¡ç­‰ç­‰ï¼Œæ‰€ä»¥ä¹Ÿå«ä¿¡ä»¤æœåŠ¡å™¨ä¹Ÿå«æˆ¿é—´æœåŠ¡å™¨ã€‚
  
- WebRTC å¹¶æ²¡æœ‰è§„å®šä¿¡ä»¤å¿…é¡»ä½¿ç”¨ä½•ç§å®ç°ï¼Œç›®å‰ä¸šç•Œä½¿ç”¨è¾ƒå¤šçš„æ˜¯ WebSocket + JSON/SDP çš„æ–¹æ¡ˆã€‚å…¶ä¸­ WebSocket ç”¨æ¥æä¾›ä¿¡ä»¤ä¼ è¾“é€šé“ï¼ŒJSON/SDP ç”¨æ¥å°è£…ä¿¡ä»¤çš„å…·ä½“å†…å®¹ã€‚
- ä¿¡ä»¤æœåŠ¡å™¨ç”¨äºåœ¨ä¸¤ä¸ªå¯¹ç­‰ç«¯ï¼ˆpeersï¼‰ä¹‹é—´äº¤æ¢è¿æ¥ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯åŒ…æ‹¬ SDPï¼ˆSession Description Protocolï¼‰æ•°æ®å’Œ ICEï¼ˆInteractive Connectivity Establishmentï¼‰å€™é€‰è€…ã€‚
- ä¿¡ä»¤æœåŠ¡å™¨æœ¬èº«ä¸å¤„ç†åª’ä½“æ•°æ®ï¼Œåªè´Ÿè´£ä¼ é€’è¿æ¥å»ºç«‹æ‰€éœ€çš„å…ƒæ•°æ®ã€‚
- åœ¨ä¸¤ä¸ªç”¨æˆ·é€šä¿¡å‰ï¼Œé¦–å…ˆä¼šå‘å…¬ç½‘çš„ STUN æœåŠ¡å‘é€è¯·æ±‚è·å–è‡ªå·±çš„å…¬ç½‘åœ°å€ï¼Œç„¶åé€šè¿‡æœåŠ¡å™¨å°†å„è‡ªçš„å…¬ç½‘åœ°å€è½¬å‘ç»™å¯¹ç­‰ç«¯ï¼Œè¿™æ ·åŒæ–¹å°±çŸ¥é“äº†å¯¹æ–¹çš„å…¬ç½‘åœ°å€ï¼Œæ ¹æ®è¿™ä¸ªå…¬ç½‘åœ°å€å°±å¯ä»¥ç›´æ¥ç‚¹å¯¹ç‚¹é€šä¿¡äº†ã€‚

å…·ä½“å®ä¾‹
åˆ›å»ºè¿æ¥
1. åŒç«¯ï¼ˆä¸¤ä¸ªå®¢æˆ·ç«¯è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨ï¼Œç­‰å¾…äº¤æ¢ä¿¡ä»¤ä¿¡æ¯ï¼‰
node signaling-server.js 
Signaling server is running on ws://0.0.0.0:53378
A new client connected
A new client connected

äº¤æ¢ä¿¡ä»¤ä¿¡æ¯
- æäº¤è‡ªèº«çš„å¯ç”¨åè®®å’ŒçŠ¶æ€ï¼ˆSDP ç»˜ç”»æè¿°åè®®ï¼‰
``` offer
{
    "type": "offer",
    "offer":
    {
        "sdp": "v=0\r\no=- 5949851614612336510 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0 1\r\na=extmap-allow-mixed\r\na=msid-semantic: WMS d15c6979-87f7-4177-b082-e54548148e46\r\nm=audio 9 UDP/TLS/RTP/SAVPF 111 63 9 0 8 13 110 126\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:JDVd\r\na=ice-pwd:kXT7EgT23rvctdmdZUSU0dT1\r\na=ice-options:trickle\r\na=fingerprint:sha-256 3B:60:C9:3B:27:5F:74:C9:AF:FE:98:15:A5:80:BA:FB:F4:09:8D:2A:EB:8D:13:1D:56:94:C3:5F:6C:D5:B7:B6\r\na=setup:actpass\r\na=mid:0\r\na=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=sendrecv\r\na=msid:d15c6979-87f7-4177-b082-e54548148e46 b8e4fae9-2614-4222-8eb2-73c42d5594d6\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rtpmap:111 opus/48000/2\r\na=rtcp-fb:111 transport-cc\r\na=fmtp:111 minptime=10;useinbandfec=1\r\na=rtpmap:63 red/48000/2\r\na=fmtp:63 111/111\r\na=rtpmap:9 G722/8000\r\na=rtpmap:0 PCMU/8000\r\na=rtpmap:8 PCMA/8000\r\na=rtpmap:13 CN/8000\r\na=rtpmap:110 telephone-event/48000\r\na=rtpmap:126 telephone-event/8000\r\na=ssrc:3437501515 cname:MxV7vls3AO3u1lWD\r\na=ssrc:3437501515 msid:d15c6979-87f7-4177-b082-e54548148e46 b8e4fae9-2614-4222-8eb2-73c42d5594d6\r\nm=video 9 UDP/TLS/RTP/SAVPF 96 97 102 103 104 105 106 107 108 109 127 125 39 40 45 46 98 99 100 101 112 113 116 117 118\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:JDVd\r\na=ice-pwd:kXT7EgT23rvctdmdZUSU0dT1\r\na=ice-options:trickle\r\na=fingerprint:sha-256 3B:60:C9:3B:27:5F:74:C9:AF:FE:98:15:A5:80:BA:FB:F4:09:8D:2A:EB:8D:13:1D:56:94:C3:5F:6C:D5:B7:B6\r\na=setup:actpass\r\na=mid:1\r\na=extmap:14 urn:ietf:params:rtp-hdrext:toffset\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:13 urn:3gpp:video-orientation\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:5 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay\r\na=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/video-content-type\r\na=extmap:7 http://www.webrtc.org/experiments/rtp-hdrext/video-timing\r\na=extmap:8 http://www.webrtc.org/experiments/rtp-hdrext/color-space\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:10 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\r\na=extmap:11 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\r\na=sendrecv\r\na=msid:d15c6979-87f7-4177-b082-e54548148e46 31e24686-c6d8-4ca8-aab0-12e6f829fe23\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rtpmap:96 VP8/90000\r\na=rtcp-fb:96 goog-remb\r\na=rtcp-fb:96 transport-cc\r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack\r\na=rtcp-fb:96 nack pli\r\na=rtpmap:97 rtx/90000\r\na=fmtp:97 apt=96\r\na=rtpmap:102 H264/90000\r\na=rtcp-fb:102 goog-remb\r\na=rtcp-fb:102 transport-cc\r\na=rtcp-fb:102 ccm fir\r\na=rtcp-fb:102 nack\r\na=rtcp-fb:102 nack pli\r\na=fmtp:102 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\r\na=rtpmap:103 rtx/90000\r\na=fmtp:103 apt=102\r\na=rtpmap:104 H264/90000\r\na=rtcp-fb:104 goog-remb\r\na=rtcp-fb:104 transport-cc\r\na=rtcp-fb:104 ccm fir\r\na=rtcp-fb:104 nack\r\na=rtcp-fb:104 nack pli\r\na=fmtp:104 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42001f\r\na=rtpmap:105 rtx/90000\r\na=fmtp:105 apt=104\r\na=rtpmap:106 H264/90000\r\na=rtcp-fb:106 goog-remb\r\na=rtcp-fb:106 transport-cc\r\na=rtcp-fb:106 ccm fir\r\na=rtcp-fb:106 nack\r\na=rtcp-fb:106 nack pli\r\na=fmtp:106 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\na=rtpmap:107 rtx/90000\r\na=fmtp:107 apt=106\r\na=rtpmap:108 H264/90000\r\na=rtcp-fb:108 goog-remb\r\na=rtcp-fb:108 transport-cc\r\na=rtcp-fb:108 ccm fir\r\na=rtcp-fb:108 nack\r\na=rtcp-fb:108 nack pli\r\na=fmtp:108 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42e01f\r\na=rtpmap:109 rtx/90000\r\na=fmtp:109 apt=108\r\na=rtpmap:127 H264/90000\r\na=rtcp-fb:127 goog-remb\r\na=rtcp-fb:127 transport-cc\r\na=rtcp-fb:127 ccm fir\r\na=rtcp-fb:127 nack\r\na=rtcp-fb:127 nack pli\r\na=fmtp:127 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=4d001f\r\na=rtpmap:125 rtx/90000\r\na=fmtp:125 apt=127\r\na=rtpmap:39 H264/90000\r\na=rtcp-fb:39 goog-remb\r\na=rtcp-fb:39 transport-cc\r\na=rtcp-fb:39 ccm fir\r\na=rtcp-fb:39 nack\r\na=rtcp-fb:39 nack pli\r\na=fmtp:39 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=4d001f\r\na=rtpmap:40 rtx/90000\r\na=fmtp:40 apt=39\r\na=rtpmap:45 AV1/90000\r\na=rtcp-fb:45 goog-remb\r\na=rtcp-fb:45 transport-cc\r\na=rtcp-fb:45 ccm fir\r\na=rtcp-fb:45 nack\r\na=rtcp-fb:45 nack pli\r\na=fmtp:45 level-idx=5;profile=0;tier=0\r\na=rtpmap:46 rtx/90000\r\na=fmtp:46 apt=45\r\na=rtpmap:98 VP9/90000\r\na=rtcp-fb:98 goog-remb\r\na=rtcp-fb:98 transport-cc\r\na=rtcp-fb:98 ccm fir\r\na=rtcp-fb:98 nack\r\na=rtcp-fb:98 nack pli\r\na=fmtp:98 profile-id=0\r\na=rtpmap:99 rtx/90000\r\na=fmtp:99 apt=98\r\na=rtpmap:100 VP9/90000\r\na=rtcp-fb:100 goog-remb\r\na=rtcp-fb:100 transport-cc\r\na=rtcp-fb:100 ccm fir\r\na=rtcp-fb:100 nack\r\na=rtcp-fb:100 nack pli\r\na=fmtp:100 profile-id=2\r\na=rtpmap:101 rtx/90000\r\na=fmtp:101 apt=100\r\na=rtpmap:112 H264/90000\r\na=rtcp-fb:112 goog-remb\r\na=rtcp-fb:112 transport-cc\r\na=rtcp-fb:112 ccm fir\r\na=rtcp-fb:112 nack\r\na=rtcp-fb:112 nack pli\r\na=fmtp:112 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=64001f\r\na=rtpmap:113 rtx/90000\r\na=fmtp:113 apt=112\r\na=rtpmap:116 red/90000\r\na=rtpmap:117 rtx/90000\r\na=fmtp:117 apt=116\r\na=rtpmap:118 ulpfec/90000\r\na=ssrc-group:FID 583334944 2876421606\r\na=ssrc:583334944 cname:MxV7vls3AO3u1lWD\r\na=ssrc:583334944 msid:d15c6979-87f7-4177-b082-e54548148e46 31e24686-c6d8-4ca8-aab0-12e6f829fe23\r\na=ssrc:2876421606 cname:MxV7vls3AO3u1lWD\r\na=ssrc:2876421606 msid:d15c6979-87f7-4177-b082-e54548148e46 31e24686-c6d8-4ca8-aab0-12e6f829fe23\r\n",
        "type": "offer"
    }
}
```

```json- answer
{
    "type": "answer",
    "answer":
    {
        "sdp": "v=0\r\no=- 6625302972082072315 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0 1\r\na=extmap-allow-mixed\r\na=msid-semantic: WMS d15c6979-87f7-4177-b082-e54548148e46\r\nm=audio 9 UDP/TLS/RTP/SAVPF 111 63 9 0 8 13 110 126\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:gZTj\r\na=ice-pwd:G6LOfaoAJg6YaajAUA1WmhkR\r\na=ice-options:trickle\r\na=fingerprint:sha-256 49:11:EC:20:6B:94:DA:60:BC:00:C5:D1:A2:38:AF:7E:E0:19:A5:F3:E5:61:9E:5F:06:5D:FD:41:9A:E5:AE:0D\r\na=setup:active\r\na=mid:0\r\na=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=sendrecv\r\na=msid:d15c6979-87f7-4177-b082-e54548148e46 b8e4fae9-2614-4222-8eb2-73c42d5594d6\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rtpmap:111 opus/48000/2\r\na=rtcp-fb:111 transport-cc\r\na=fmtp:111 minptime=10;useinbandfec=1\r\na=rtpmap:63 red/48000/2\r\na=fmtp:63 111/111\r\na=rtpmap:9 G722/8000\r\na=rtpmap:0 PCMU/8000\r\na=rtpmap:8 PCMA/8000\r\na=rtpmap:13 CN/8000\r\na=rtpmap:110 telephone-event/48000\r\na=rtpmap:126 telephone-event/8000\r\na=ssrc:1889325369 cname:j2CRPSmMvx2vVnI/\r\nm=video 9 UDP/TLS/RTP/SAVPF 96 97 102 103 104 105 106 107 108 109 127 125 39 40 45 46 98 99 100 101 112 113 116 117 118\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:gZTj\r\na=ice-pwd:G6LOfaoAJg6YaajAUA1WmhkR\r\na=ice-options:trickle\r\na=fingerprint:sha-256 49:11:EC:20:6B:94:DA:60:BC:00:C5:D1:A2:38:AF:7E:E0:19:A5:F3:E5:61:9E:5F:06:5D:FD:41:9A:E5:AE:0D\r\na=setup:active\r\na=mid:1\r\na=extmap:14 urn:ietf:params:rtp-hdrext:toffset\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:13 urn:3gpp:video-orientation\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:5 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay\r\na=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/video-content-type\r\na=extmap:7 http://www.webrtc.org/experiments/rtp-hdrext/video-timing\r\na=extmap:8 http://www.webrtc.org/experiments/rtp-hdrext/color-space\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:10 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\r\na=extmap:11 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\r\na=sendrecv\r\na=msid:d15c6979-87f7-4177-b082-e54548148e46 31e24686-c6d8-4ca8-aab0-12e6f829fe23\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rtpmap:96 VP8/90000\r\na=rtcp-fb:96 goog-remb\r\na=rtcp-fb:96 transport-cc\r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack\r\na=rtcp-fb:96 nack pli\r\na=rtpmap:97 rtx/90000\r\na=fmtp:97 apt=96\r\na=rtpmap:102 H264/90000\r\na=rtcp-fb:102 goog-remb\r\na=rtcp-fb:102 transport-cc\r\na=rtcp-fb:102 ccm fir\r\na=rtcp-fb:102 nack\r\na=rtcp-fb:102 nack pli\r\na=fmtp:102 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\r\na=rtpmap:103 rtx/90000\r\na=fmtp:103 apt=102\r\na=rtpmap:104 H264/90000\r\na=rtcp-fb:104 goog-remb\r\na=rtcp-fb:104 transport-cc\r\na=rtcp-fb:104 ccm fir\r\na=rtcp-fb:104 nack\r\na=rtcp-fb:104 nack pli\r\na=fmtp:104 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42001f\r\na=rtpmap:105 rtx/90000\r\na=fmtp:105 apt=104\r\na=rtpmap:106 H264/90000\r\na=rtcp-fb:106 goog-remb\r\na=rtcp-fb:106 transport-cc\r\na=rtcp-fb:106 ccm fir\r\na=rtcp-fb:106 nack\r\na=rtcp-fb:106 nack pli\r\na=fmtp:106 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\na=rtpmap:107 rtx/90000\r\na=fmtp:107 apt=106\r\na=rtpmap:108 H264/90000\r\na=rtcp-fb:108 goog-remb\r\na=rtcp-fb:108 transport-cc\r\na=rtcp-fb:108 ccm fir\r\na=rtcp-fb:108 nack\r\na=rtcp-fb:108 nack pli\r\na=fmtp:108 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42e01f\r\na=rtpmap:109 rtx/90000\r\na=fmtp:109 apt=108\r\na=rtpmap:127 H264/90000\r\na=rtcp-fb:127 goog-remb\r\na=rtcp-fb:127 transport-cc\r\na=rtcp-fb:127 ccm fir\r\na=rtcp-fb:127 nack\r\na=rtcp-fb:127 nack pli\r\na=fmtp:127 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=4d001f\r\na=rtpmap:125 rtx/90000\r\na=fmtp:125 apt=127\r\na=rtpmap:39 H264/90000\r\na=rtcp-fb:39 goog-remb\r\na=rtcp-fb:39 transport-cc\r\na=rtcp-fb:39 ccm fir\r\na=rtcp-fb:39 nack\r\na=rtcp-fb:39 nack pli\r\na=fmtp:39 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=4d001f\r\na=rtpmap:40 rtx/90000\r\na=fmtp:40 apt=39\r\na=rtpmap:45 AV1/90000\r\na=rtcp-fb:45 goog-remb\r\na=rtcp-fb:45 transport-cc\r\na=rtcp-fb:45 ccm fir\r\na=rtcp-fb:45 nack\r\na=rtcp-fb:45 nack pli\r\na=fmtp:45 level-idx=5;profile=0;tier=0\r\na=rtpmap:46 rtx/90000\r\na=fmtp:46 apt=45\r\na=rtpmap:98 VP9/90000\r\na=rtcp-fb:98 goog-remb\r\na=rtcp-fb:98 transport-cc\r\na=rtcp-fb:98 ccm fir\r\na=rtcp-fb:98 nack\r\na=rtcp-fb:98 nack pli\r\na=fmtp:98 profile-id=0\r\na=rtpmap:99 rtx/90000\r\na=fmtp:99 apt=98\r\na=rtpmap:100 VP9/90000\r\na=rtcp-fb:100 goog-remb\r\na=rtcp-fb:100 transport-cc\r\na=rtcp-fb:100 ccm fir\r\na=rtcp-fb:100 nack\r\na=rtcp-fb:100 nack pli\r\na=fmtp:100 profile-id=2\r\na=rtpmap:101 rtx/90000\r\na=fmtp:101 apt=100\r\na=rtpmap:112 H264/90000\r\na=rtcp-fb:112 goog-remb\r\na=rtcp-fb:112 transport-cc\r\na=rtcp-fb:112 ccm fir\r\na=rtcp-fb:112 nack\r\na=rtcp-fb:112 nack pli\r\na=fmtp:112 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=64001f\r\na=rtpmap:113 rtx/90000\r\na=fmtp:113 apt=112\r\na=rtpmap:116 red/90000\r\na=rtpmap:117 rtx/90000\r\na=fmtp:117 apt=116\r\na=rtpmap:118 ulpfec/90000\r\na=ssrc-group:FID 1692434634 1983657469\r\na=ssrc:1692434634 cname:j2CRPSmMvx2vVnI/\r\na=ssrc:1983657469 cname:j2CRPSmMvx2vVnI/\r\n",
        "type": "answer"
    }
}
```
- ä¿¡ä»¤æœåŠ¡å™¨ä»£ç 
const WebSocket = require('ws');

// åˆ›å»º WebSocket æœåŠ¡å™¨å¹¶ç›‘å¬ 0.0.0.0:53378
const wss = new WebSocket.Server({ host: '0.0.0.0', port: 53378 });

wss.on('connection', function connection(ws) {
  console.log('A new client connected');

  ws.on('message', function incoming(message) {
    console.log('received: %s', message);

    // è§£ææ¥æ”¶åˆ°çš„æ¶ˆæ¯
    let parsedMessage;
    try {
      parsedMessage = JSON.parse(message);
    } catch (error) {
      console.error('Error parsing message:', error);
      return;
    }

    // å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
    wss.clients.forEach(function each(client) {
      if (client !== ws && client.readyState === WebSocket.OPEN) {
        client.send(JSON.stringify(parsedMessage));
      }
    });
  });

  ws.on('close', function close() {
    console.log('Client disconnected');
  });
});

console.log('Signaling server is running on ws://0.0.0.0:53378');

äº¤æ¢Candidate ï¼ˆå€™é€‰è€…äº¤æ¢ï¼‰
- Candidateæ•°æ®ï¼ˆæœ¬åœ°IPåœ°å€ã€å…¬ç½‘IPåœ°å€ã€RelayæœåŠ¡ç«¯åˆ†é…çš„åœ°å€ï¼‰
[
    {
        "type": "candidate",
        "candidate":
        {
            "candidate": "candidate:3096071039 1 udp 2122260223 10.25.39.1 60751 typ host generation 0 ufrag N/KY network-id 1 network-cost 10",
            "sdpMid": "0",
            "sdpMLineIndex": 0,
            "usernameFragment": "N/KY"
        }
    },
    {
        "type": "candidate",
        "candidate":
        {
            "candidate": "candidate:3096071039 1 udp 2122260223 10.25.39.1 57043 typ host generation 0 ufrag N/KY network-id 1 network-cost 10",
            "sdpMid": "1",
            "sdpMLineIndex": 1,
            "usernameFragment": "N/KY"
        }
    },
    {
        "type": "candidate",
        "candidate":
        {
            "candidate": "candidate:2649982101 1 udp 1686052607 219.142.117.143 2213 typ srflx raddr 10.25.39.1 rport 57043 generation 0 ufrag N/KY network-id 1 network-cost 10",
            "sdpMid": "1",
            "sdpMLineIndex": 1,
            "usernameFragment": "N/KY"
        }
    },
    {
        "type": "candidate",
        "candidate":
        {
            "candidate": "candidate:2649982101 1 udp 1686052607 219.142.117.143 2212 typ srflx raddr 10.25.39.1 rport 60751 generation 0 ufrag N/KY network-id 1 network-cost 10",
            "sdpMid": "0",
            "sdpMLineIndex": 0,
            "usernameFragment": "N/KY"
        }
    }
]

è¿›è¡ŒP2Pè¿æ¥
[å›¾ç‰‡]
åŒæ–¹å»ºç«‹P2Pçš„æµç¨‹
[å›¾ç‰‡]
1. åŒæ–¹å…ˆè°ƒç”¨ getUserMedia æ‰“å¼€æœ¬åœ°æ‘„åƒå¤´ï¼›
2. å‘ä¿¡ä»¤æœåŠ¡å™¨å‘é€åŠ å…¥è¯·æ±‚ï¼›
3. Peer B æ¥æ”¶åˆ° Peer A å‘é€çš„ offer SDP å¯¹è±¡ï¼Œå¹¶é€šè¿‡PeerConnectionçš„SetLocalDescriptionæ–¹æ³•ä¿å­˜ Answer SDP å¯¹è±¡å¹¶å°†å®ƒé€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€ç»™ Peer Aã€‚SDPä»¥JSONçš„å½¢å¼å‘é€
4. åœ¨ SDP ä¿¡æ¯çš„ offer/answer æµç¨‹ä¸­ï¼ŒPeer A å’Œ Peer B å·²ç»æ ¹æ® SDP ä¿¡æ¯åˆ›å»ºå¥½ç›¸åº”çš„éŸ³é¢‘ Channel å’Œè§†é¢‘ Channelï¼Œå¹¶å¼€å¯Candidate æ•°æ®çš„æ”¶é›†ï¼ŒCandidateæ•°æ®ï¼ˆæœ¬åœ°IPåœ°å€ã€å…¬ç½‘IPåœ°å€ã€RelayæœåŠ¡ç«¯åˆ†é…çš„åœ°å€ï¼‰ã€‚
5. å½“ Peer A æ”¶é›†åˆ° Candidate  ä¿¡æ¯åé€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€ç»™ Peer Bã€‚åŒæ ·çš„è¿‡ç¨‹ Peer B å¯¹ Peer A ä¹Ÿä¼šå†å‘é€ä¸€æ¬¡ã€‚

æµåª’ä½“ä¼ è¾“æœºåˆ¶
æµåª’ä½“ä¼ è¾“çš„åº•å±‚æœºåˆ¶
WebRTC ä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯å’Œåè®®æ¥å®ç°æµåª’ä½“çš„ä¼ è¾“ï¼š
1. RTPï¼ˆå®æ—¶ä¼ è¾“åè®®ï¼‰ï¼š
RTP æ˜¯ç”¨äºåœ¨äº’è”ç½‘ä¸Šä¼ è¾“éŸ³é¢‘å’Œè§†é¢‘çš„åè®®ã€‚WebRTC ä½¿ç”¨ RTP æ¥ä¼ è¾“åª’ä½“æµã€‚
2. SRTPï¼ˆå®‰å…¨å®æ—¶ä¼ è¾“åè®®ï¼‰ï¼š
ä¸ºäº†ç¡®ä¿ä¼ è¾“çš„å®‰å…¨æ€§ï¼ŒWebRTC ä½¿ç”¨ SRTP å¯¹åª’ä½“æµè¿›è¡ŒåŠ å¯†ã€‚
3. STUNï¼ˆä¼šè¯ç©¿è¶Šå®ç”¨ç¨‹åºï¼‰å’Œ TURNï¼ˆä¼ è¾“ä¸­ç»§ï¼‰ï¼š
è¿™äº›åè®®ç”¨äº NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰ç©¿è¶Šï¼Œå¸®åŠ©å¯¹ç­‰ç«¯æ‰¾åˆ°å½¼æ­¤å¹¶å»ºç«‹è¿æ¥ã€‚STUN æœåŠ¡å™¨ç”¨äºè·å–å…¬å…± IP åœ°å€å’Œç«¯å£ï¼Œè€Œ TURN æœåŠ¡å™¨ç”¨äºåœ¨ç›´æ¥è¿æ¥ä¸å¯è¡Œæ—¶ä¸­ç»§æµé‡ã€‚
4. DTLSï¼ˆæ•°æ®æŠ¥ä¼ è¾“å±‚å®‰å…¨åè®®ï¼‰ï¼š
ç”¨äºåŠ å¯† WebRTC ä¿¡ä»¤å’Œæ•°æ®é€šé“çš„ä¼ è¾“ï¼Œç¡®ä¿æ•°æ®çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ã€‚
5. SCTPï¼ˆæµæ§åˆ¶ä¼ è¾“åè®®ï¼‰ï¼š
ç”¨äº WebRTC æ•°æ®é€šé“ï¼Œæ”¯æŒå¯é çš„æ•°æ®ä¼ è¾“ã€‚
é€šè¿‡è¿™äº›åè®®å’ŒæŠ€æœ¯ï¼ŒWebRTC å®ç°äº†é«˜æ•ˆã€ä½å»¶è¿Ÿçš„ç«¯åˆ°ç«¯æµåª’ä½“ä¼ è¾“ã€‚æ•´ä¸ªè¿‡ç¨‹ä»è·å–æœ¬åœ°åª’ä½“æµã€åˆ›å»ºå’Œäº¤æ¢ SDPã€äº¤æ¢ ICE å€™é€‰è€…ï¼Œåˆ°æœ€ç»ˆå»ºç«‹è¿æ¥å¹¶å¼€å§‹ä¼ è¾“ï¼Œéƒ½æ˜¯ä¸ºäº†ç¡®ä¿å®æ—¶é€šä¿¡çš„è´¨é‡å’Œå¯é æ€§ã€‚


WebSocket å’Œ WebRTCçš„åŒºåˆ«
1. WebSocketæ˜¯ä¸€ç§ç½‘ç»œé€šä¿¡åè®®ï¼Œå…è®¸åœ¨WebæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´å»ºç«‹æŒä¹…çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚è€ŒWebRTCï¼Œå…¨ç§°ä¸ºWebå®æ—¶é€šä¿¡ï¼Œæ˜¯ä¸€ç§æ”¯æŒå®æ—¶éŸ³è§†é¢‘é€šä¿¡çš„å¼€æ”¾æ ‡å‡†ï¼Œå®ƒå…è®¸åœ¨æ— æ’ä»¶çš„æµè§ˆå™¨ä¹‹é—´è¿›è¡Œç‚¹å¯¹ç‚¹ï¼ˆP2Pï¼‰é€šä¿¡ã€‚
2. é€šä¿¡æ–¹å¼ï¼šWebSocketæ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„åŒå‘é€šä¿¡åè®®ã€‚ä¸€æ—¦å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½å¯ä»¥ä¸»åŠ¨å‘é€æ•°æ®ã€‚è€ŒWebRTCæ˜¯åŸºäºP2Pçš„å®æ—¶é€šä¿¡æŠ€æœ¯ï¼Œå…è®¸æµè§ˆå™¨ä¹‹é—´ç›´æ¥è¿›è¡ŒéŸ³è§†é¢‘æµä¼ è¾“ï¼Œæ— éœ€ç»è¿‡æœåŠ¡å™¨è½¬å‘ã€‚

WebRTCåœ¨æµè§ˆå™¨ä¸­çš„åº”ç”¨åœºæ™¯
WebRTCçš„APIç¡®å®æ˜¯é»˜è®¤åµŒå…¥åœ¨ç°ä»£æµè§ˆå™¨ä¸­çš„JavaScriptç¯å¢ƒé‡Œï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ç›´æ¥åœ¨JavaScriptä»£ç ä¸­ä½¿ç”¨WebRTCçš„ç›¸å…³å¯¹è±¡å’Œæ–¹æ³•ï¼Œè€Œæ— éœ€é¢å¤–çš„åº“æˆ–æ’ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®ç‚¹ï¼Œè§£é‡Šä¸ºä»€ä¹ˆä½ å¯ä»¥ç›´æ¥ä½¿ç”¨WebRTCçš„APIï¼š
1. æµè§ˆå™¨æ”¯æŒï¼š
ç°ä»£æµè§ˆå™¨ï¼ˆå¦‚Google Chromeã€Mozilla Firefoxã€Microsoft Edgeå’ŒSafariï¼‰éƒ½å†…ç½®äº†å¯¹WebRTCçš„æ”¯æŒã€‚è¿™äº›æµè§ˆå™¨å®ç°äº†WebRTCçš„æ ‡å‡†APIï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥ç›´æ¥åœ¨JavaScriptä¸­è°ƒç”¨è¿™äº›APIã€‚
2. æ ‡å‡†åŒ–APIï¼š
WebRTCæ˜¯ç”±W3Cï¼ˆWorld Wide Web Consortiumï¼‰å’ŒIETFï¼ˆInternet Engineering Task Forceï¼‰å…±åŒåˆ¶å®šçš„æ ‡å‡†ã€‚æ ‡å‡†åŒ–çš„APIç¡®ä¿äº†è·¨æµè§ˆå™¨çš„ä¸€è‡´æ€§ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥ç¼–å†™ä¸€æ¬¡ä»£ç ï¼Œåœ¨å¤šä¸ªæµè§ˆå™¨ä¸­è¿è¡Œã€‚
3. å†…ç½®å¯¹è±¡å’Œæ–¹æ³•ï¼š
WebRTCçš„APIåŒ…æ‹¬ä¸€ç»„å†…ç½®çš„JavaScriptå¯¹è±¡å’Œæ–¹æ³•ï¼Œå¦‚RTCPeerConnectionã€getUserMediaã€RTCDataChannelç­‰ã€‚è¿™äº›å¯¹è±¡å’Œæ–¹æ³•ç›´æ¥åœ¨æµè§ˆå™¨çš„JavaScriptç¯å¢ƒä¸­å¯ç”¨ï¼Œæ— éœ€é¢å¤–åŠ è½½ã€‚

é€å¸§è§£æSDPäº¤æ¢å’ŒIPäº¤æ¢çš„è¿‡ç¨‹
[å›¾ç‰‡]
webRTCæ¶‰åŠçš„å…³é”®è¯
1. offerï¼šä¸€ç«¯å‘èµ·çš„è¯·æ±‚ï¼Œå†…å«å®¢æˆ·ç«¯Amyçš„SDPä¿¡æ¯ã€‚
2. answerï¼šå¯¹ç«¯è¿”å›çš„å“åº”ï¼Œå†…å«å¯¹ç«¯Bobçš„SDPä¿¡æ¯
3. setLocalDescriptionï¼šå°†æœ¬åœ°çš„SDPä¿¡æ¯ä¿å­˜
4. setRemoteDescriptionï¼šå°†å¯¹ç«¯å‘é€çš„offerä¸­çš„SDPä¿¡æ¯ä¿å­˜èµ·æ¥
5. candidateï¼šè¿™æœ¬è´¨æ˜¯ä¸€ä¸ªjsonï¼Œå«æœ‰å½“å‰å®¢æˆ·ç«¯å„è‡ªçš„ã€Œå…¬ç½‘ã€å†…ç½‘ã€æœ¬åœ°ã€ipå’Œportä¿¡æ¯ã€‚
6. SDPï¼šSDPï¼ˆSession Description Protocolï¼‰æŒ‡ä¼šè¯æè¿°åè®®ï¼Œæ˜¯ä¸€ç§é€šç”¨çš„åè®®ï¼ŒåŸºäºæ–‡æœ¬ï¼Œå…¶æœ¬èº«å¹¶ä¸å±äºä¼ è¾“åè®®ã€‚SDPæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç¼–ç ï¼Œè¡¨ç¤ºå„ç«¯çš„èƒ½åŠ›ï¼ŒåŒ…æ‹¬ä¸é™äºéŸ³è§†é¢‘ç¼–ç æ ¼å¼ï¼Œå¸¦å®½ï¼Œæµæ§ç­–ç•¥ç­‰ï¼›è§£å†³å‰ç½®æ€è€ƒä¸­ï¼ŒåŒæ–¹èƒ½åŠ›ä¸åŒ¹é…é—®é¢˜ï¼Œé€šè¿‡äº¤æ¢åŒæ–¹ SDP æµè§ˆå™¨ä¼šè‡ªåŠ¨é€‰æ‹©åŒæ–¹éƒ½æ”¯æŒçš„è§†é¢‘ç¼–ç æ ¼å¼ï¼ˆå–äº¤é›†ï¼‰ã€‚
1. å»ºç«‹WebSocketè¿æ¥ & ç‚¹å‡»å‡†å¤‡æŒ‰é’®
[å›¾ç‰‡]
1. ä¿¡ä»¤äº‹ä»¶æ¥æ”¶å™¨
signaling.onmessage = e => {
  if (!localStream) {
    console.log('not ready yet');
    return;
  }
  switch (e.data.type) {
    case 'offer':
      handleOffer(e.data);
      break;
    case 'answer':
      handleAnswer(e.data);
      break;
    case 'candidate':
      handleCandidate(e.data);
      break;
    case 'ready':
      // A second tab joined. This tab will initiate a call unless in a call already.
      if (pc) {
        console.log('already in call, ignoring');
        return;
      }
      makeCall();
      break;
    case 'bye':
      if (pc) {
        hangup();
      }
      break;
    default:
      console.log('unhandled', e);
      break;
  }
};
2. startæŒ‰é’®ç‚¹å‡»äº‹ä»¶
startButton.onclick = async () => {
  localStream = await navigator.mediaDevices.getUserMedia({audio: true, video: true});
  localVideo.srcObject = localStream;

  startButton.disabled = true;
  hangupButton.disabled = false;

  signaling.postMessage({type: 'ready'});
};
3. å½“ç”¨æˆ·è¿›å…¥é¡µé¢ä¹‹åå°±å…ˆè¿æ¥WebSocketæœåŠ¡å™¨
4. å½“ä¸€ç«¯ç‚¹å‡»startä¹‹åï¼Œå‘ä¿¡ä»¤æœåŠ¡å™¨å‘é€readyè¯·æ±‚ã€‚
5. å¦‚æœå¯¹ç«¯çš„æœ¬åœ°æµæ²¡æœ‰å»ºç«‹å¥½ï¼Œå¯¹ç«¯å°±ä¸å“åº”ã€‚åªæœ‰å¯¹ç«¯ä¹Ÿç‚¹å‡»startï¼Œå¯¹ç«¯å‘ä¿¡ä»¤æœåŠ¡å™¨å‘é€readyè¯·æ±‚ï¼Œæ­¤æ—¶å½“å‰å®¢æˆ·ç«¯æ¥æ”¶webSockctçš„äº‹ä»¶æ‰§è¡ŒmakeCall()åŒæ–¹æ‰å¼€å§‹å‡†å¤‡è¿›è¡ŒSDPå’Œcandidateäº¤æ¢ã€‚

2. offeråˆ›å»ºå¹¶å‘é€
1. offeråªè´Ÿè´£ä¼ SDPï¼Œä¼ è¾“æœ¬åœ°åª’ä½“æ ¼å¼ä¿¡æ¯
// åˆ›å»ºwebRTCè¿æ¥çš„å®ä¾‹
function createPeerConnection() {
  pc = new RTCPeerConnection();
  
  // âš ï¸æœ€å…³é”®çš„åœ°æ–¹ï¼ ç»™onicecandidateæˆå‘˜å˜é‡ç»‘å®šä¸€ä¸ªè§¦å‘äº‹ä»¶ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰
  pc.onicecandidate = function iceCallback(e) {
    const message = {
      type: 'candidate',
      candidate: null,
    };
    if (e.candidate) {
      message.candidate = e.candidate.candidate;
      message.sdpMid = e.candidate.sdpMid;
      message.sdpMLineIndex = e.candidate.sdpMLineIndex;
    }
    console.log('onicecandidateçš„å›è°ƒå‡½æ•°æ‰§è¡Œ', message);
    signaling.postMessage(message);
  };
  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
}

// makeCall sdpå’Œcandidateäº¤äº’çš„èµ·ç‚¹
async function makeCall() {
  console.log('start ====> createPeerConnection');
  await createPeerConnection();
  console.log('end <==== createPeerConnection');

  
  const offer = await pc.createOffer();
  signaling.postMessage({type: 'offer', sdp: offer.sdp});
  console.log('å‘é€offer', JSON.stringify(offer));

  await pc.setLocalDescription(offer);
  console.log('å°†æœ¬åœ°çš„sdpä¿¡æ¯ä¿å­˜èµ·æ¥');
}
3. ç»‘å®šçš„äº‹ä»¶è§¦å‘æ‰§è¡Œå›è°ƒï¼ˆå‘é€candidateäº¤æ¢å€™é€‰äººï¼‰
1. iceCallbackæ˜¯ä¸ªå›è°ƒå‡½æ•°å°†ä»STUNè·å–åˆ°çš„å…¬ç½‘IPå’ŒPortå‘é€åˆ°ä¿¡ä»¤æœåŠ¡å™¨
2. iceCallbackçš„è§¦å‘æ—¶æœºæ˜¯åœ¨pc.setLocalDescription(offer)ä¸­ï¼ˆæœ¬åœ°SDPä¿å­˜ä¹‹åä¼šè§¦å‘iceäº¤äº’çš„é€»è¾‘ï¼‰
[å›¾ç‰‡]
4. å›è°ƒå‡½æ•°çš„å…·ä½“é€»è¾‘ï¼ˆè§¦å‘JSäº‹ä»¶ï¼Œå‘å¯¹ç«¯å‘é€candidateï¼‰
1. STUNæœåŠ¡å™¨è¿”å›å…¬ç½‘IPä¿¡æ¯
2. eventå˜é‡è´Ÿè´£æ¥æ”¶STUNè¿”å›çš„å…¬ç½‘IPä¿¡æ¯
  1. ç„¶åå‘ä¿¡ä»¤æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼ˆå‘é€candidateå€™é€‰è€…ï¼Œå¤šä¸ªipå’Œportã€Œæœ¬åœ°ã€å†…ç½‘ã€å…¬ç½‘ã€ï¼Œå­˜åœ¨å¤šä¸ªå€™é€‰è€…ï¼‰
pc.onicecandidate = function iceCallback(e) {
    const message = {
      type: 'candidate',
      candidate: null,
    };
    // å°è£…jsonæ¶ˆæ¯
    // STUNå¤„ç†çš„IPä¿¡æ¯ä¼ å…¥eè¿™ä¸ªå˜é‡ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªäº‹ä»¶
    if (e.candidate) {
      message.candidate = e.candidate.candidate;
      message.sdpMid = e.candidate.sdpMid;
      message.sdpMLineIndex = e.candidate.sdpMLineIndex;
    }
    console.log('onicecandidateçš„å›è°ƒå‡½æ•°æ‰§è¡Œ', message);
    signaling.postMessage(message);
  };
  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
3. candidateï¼šå‘ä¿¡ä»¤æœåŠ¡å™¨ï¼ˆwebSocketï¼‰å‘é€çš„JSONæ•°æ®æ ¼å¼ï¼ˆæ‹¿äº†ä¸€ä¸ªå†…ç½‘çš„IPå’ŒPORTä½œä¸ºä¾‹å­æ”¾åœ¨è¿™é‡Œäº†ï¼‰
{
    "type": "candidate",
    "candidate": "candidate:2789144953 1 udp 2122129151 10.18.117.180 51018 typ host generation 0 ufrag ddSd network-id 3 network-cost 50",
    "sdpMid": "0",
    "sdpMLineIndex": 0
}
5. webSocketè¿›è¡Œå¹¿æ’­ğŸ“¢
1. websocketå¤„ç†äº‹ä»¶ã€‚å½“æ¥æ”¶åˆ°æ¶ˆæ¯çš„æ—¶å€™è§¦å‘äº‹ä»¶ï¼Œç„¶åæ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆåœ¨incomingå‡½æ•°ä¸­ï¼‰ï¼Œæœ€åå°†å¤„ç†åçš„æ¶ˆæ¯æˆ–è€…æ˜¯åŸæ¶ˆæ¯ç›´æ¥å¹¿æ’­ç»™å…¶ä»–å®¢æˆ·ç«¯ã€‚
2. æ³¨æ„âš ï¸ï¼šè¿™é‡Œä¸ä¸€å®šæ˜¯å¹¿æ’­ï¼Œè€ƒè™‘åˆ°æˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬è¦å‘æŒ‡å®šçš„ipå‘é€æ¶ˆæ¯ï¼Œé‚£å°±åœ¨éå†çš„è¿‡ç¨‹ä¸­åšä¸€å±‚è¿‡æ»¤ï¼Œå‘æŒ‡å®šçš„ipå‘é€æ¶ˆæ¯å°±å¥½äº†ã€‚
// åˆ›å»º WebSocket æœåŠ¡å™¨å¹¶ç›‘å¬ 0.0.0.0:53378
const wss = new WebSocket.Server({ host: '0.0.0.0', port: 53378 });

wss.on('connection', function connection(ws,req) {
  console.log('A new client connected');
  const ip = req.socket.remoteAddress;
  const port = req.socket.remotePort;
  console.log(`New client connected from IP: ${ip} PORT:${port}`);

  // å½“è·å–åˆ°äº‹ä»¶ä¹‹åè¿›è¡Œè§¦å‘æ“ä½œ
  ws.on('message', function incoming(message) {
    console.log('received: %s', message);

    // è§£ææ¥æ”¶åˆ°çš„æ¶ˆæ¯
    let parsedMessage;
    try {
      parsedMessage = JSON.parse(message);
    } catch (error) {
      console.error('Error parsing message:', error);
      return;
    }

    // å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
    // å‘æ‰€æœ‰"å¤„äºå‡†å¤‡" åŒæ—¶ "ä¸æ˜¯è‡ªå·±" çš„å…¶ä»–å®¢æˆ·ç«¯å‘é€å¹¿æ’­æ¶ˆæ¯
    wss.clients.forEach(function each(client) {
      if (client !== ws && client.readyState === WebSocket.OPEN) {
        client.send(JSON.stringify(parsedMessage));
      }
    });
  });

  ws.on('close', function close() {
    console.log('Client disconnected');
  });
});

console.log('Signaling server is running on ws://0.0.0.0:53378');

6. å®¢æˆ·ç«¯æ¥å—SDP å’Œ candidate ä¿¡æ¯ è¿›è¡Œå¤„ç†
1. æ³¨æ„âš ï¸ï¼š
  1. candidateä¿¡æ¯çš„å‘é€æ˜¯setLocalDescription(offer)åï¼Œäº¤ç”±å›è°ƒå‡½æ•°æ‰§è¡Œçš„ï¼Œå›è°ƒå‡½æ•°ç”±onicecandidateæˆå‘˜å˜é‡è¿›è¡Œç»‘å®šï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼‰ã€‚
  2. å‘é€offerçš„sendæ“ä½œæ˜¯æ—©äº candidate çš„å‘é€çš„ã€‚
  3. WebSocketä¸­æ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶æ˜¯åŸºäºTCPçš„ï¼ŒTCPåè®®ä¿è¯äº†æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Œæ‰€ä»¥å¯¹ç«¯ä¸€å®šå…ˆæ¥æ”¶åˆ°offerå†æ¥æ”¶åˆ°candidateä¿¡æ¯
  4. â—ï¸â—ï¸â—ï¸ä¿¡ä»¤æœåŠ¡å™¨å¹¿æ’­å‡ºå»çš„ip å’Œ port æ³¨æ„ã€‚ä¸€ç»„ip å’Œ port ç»„æˆçš„ä¿¡æ¯ç§°ä¸ºä¸€ä¸ªcandidateï¼Œcandadateæœ‰å¤šç»„ï¼ŒåŒ…å«ã€Œæœ¬åœ°ip&portã€å†…ç½‘ip&portã€å…¬ç½‘ip&portã€ã€‚å¹¿æ’­å‡ºå»çš„candidateæœ‰å¤šä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰å¤šæ¬¡å¹¿æ’­æ“ä½œã€‚å¤šæ¬¡å¹¿æ’­æ“ä½œæ˜¯onicecandidateç»‘å®šçš„å›è°ƒå‡½æ•°è§¦å‘çš„ã€‚
    
7. å¤„ç†offer å’Œ candidate
1. signaling.onmessageå¤„ç†ä¿¡ä»¤æœåŠ¡å™¨ï¼ˆWebSocketï¼‰è§¦å‘çš„äº‹ä»¶ã€‚ä¿¡ä»¤æœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªjsonã€‚
2. æ ¹æ®jsonä¸­çš„typeå­—æ®µï¼Œåˆ†åˆ«è°ƒç”¨ handleOffer å’Œ handleCandidate å¤„ç†SDPä¿¡æ¯å’Œcandaiteä¿¡æ¯ï¼ˆå¯¹ç«¯çš„ipå’Œportï¼‰
signaling.onmessage = e => {
  if (!localStream) {
    console.log('not ready yet');
    return;
  }
  switch (e.data.type) {
    case 'offer':
      handleOffer(e.data);
      break;
    case 'answer':
      handleAnswer(e.data);
      break;
    case 'candidate':
      handleCandidate(e.data);
      break;
    case 'ready':
      // A second tab joined. This tab will initiate a call unless in a call already.
      if (pc) {
        console.log('already in call, ignoring');
        return;
      }
      makeCall();
      break;
    case 'bye':
      if (pc) {
        hangup();
      }
      break;
    default:
      console.log('unhandled', e);
      break;
  }
};

3. WebSocketè¿”å›çš„jsonç¤ºä¾‹ï¼š
{
    "type": "candidate",
    "candidate": "candidate:2789144953 1 udp 2122129151 10.18.117.180 51018 typ host generation 0 ufrag ddSd network-id 3 network-cost 50",
    "sdpMid": "0",
    "sdpMLineIndex": 0
}

{
    "type": "offer",
    "offer":
    {
        "sdp": "v=0\r\no=- 5949851614612336510 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0 1\r\na=extmap-allow-mixed\r\na=msid-semantic: WMS d15c6979-87f7-4177-b082-e54548148e46\r\nm=audio 9 UDP/TLS/RTP/SAVPF 111 63 9 0 8 13 110 126\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:JDVd\r\na=ice-pwd:kXT7EgT23rvctdmdZUSU0dT1\r\na=ice-options:trickle\r\na=fingerprint:sha-256 3B:60:C9:3B:27:5F:74:C9:AF:FE:98:15:A5:80:BA:FB:F4:09:8D:2A:EB:8D:13:1D:56:94:C3:5F:6C:D5:B7:B6\r\na=setup:actpass\r\na=mid:0\r\na=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=sendrecv\r\na=msid:d15c6979-87f7-4177-b082-e54548148e46 b8e4fae9-2614-4222-8eb2-73c42d5594d6\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rtpmap:111 opus/48000/2\r\na=rtcp-fb:111 transport-cc\r\na=fmtp:111 minptime=10;useinbandfec=1\r\na=rtpmap:63 red/48000/2\r\na=fmtp:63 111/111\r\na=rtpmap:9 G722/8000\r\na=rtpmap:0 PCMU/8000\r\na=rtpmap:8 PCMA/8000\r\na=rtpmap:13 CN/8000\r\na=rtpmap:110 telephone-event/48000\r\na=rtpmap:126 telephone-event/8000\r\na=ssrc:3437501515 cname:MxV7vls3AO3u1lWD\r\na=ssrc:3437501515 msid:d15c6979-87f7-4177-b082-e54548148e46 b8e4fae9-2614-4222-8eb2-73c42d5594d6\r\nm=video 9 UDP/TLS/RTP/SAVPF 96 97 102 103 104 105 106 107 108 109 127 125 39 40 45 46 98 99 100 101 112 113 116 117 118\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:JDVd\r\na=ice-pwd:kXT7EgT23rvctdmdZUSU0dT1\r\na=ice-options:trickle\r\na=fingerprint:sha-256 3B:60:C9:3B:27:5F:74:C9:AF:FE:98:15:A5:80:BA:FB:F4:09:8D:2A:EB:8D:13:1D:56:94:C3:5F:6C:D5:B7:B6\r\na=setup:actpass\r\na=mid:1\r\na=extmap:14 urn:ietf:params:rtp-hdrext:toffset\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:13 urn:3gpp:video-orientation\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:5 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay\r\na=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/video-content-type\r\na=extmap:7 http://www.webrtc.org/experiments/rtp-hdrext/video-timing\r\na=extmap:8 http://www.webrtc.org/experiments/rtp-hdrext/color-space\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:10 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\r\na=extmap:11 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\r\na=sendrecv\r\na=msid:d15c6979-87f7-4177-b082-e54548148e46 31e24686-c6d8-4ca8-aab0-12e6f829fe23\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rtpmap:96 VP8/90000\r\na=rtcp-fb:96 goog-remb\r\na=rtcp-fb:96 transport-cc\r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack\r\na=rtcp-fb:96 nack pli\r\na=rtpmap:97 rtx/90000\r\na=fmtp:97 apt=96\r\na=rtpmap:102 H264/90000\r\na=rtcp-fb:102 goog-remb\r\na=rtcp-fb:102 transport-cc\r\na=rtcp-fb:102 ccm fir\r\na=rtcp-fb:102 nack\r\na=rtcp-fb:102 nack pli\r\na=fmtp:102 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\r\na=rtpmap:103 rtx/90000\r\na=fmtp:103 apt=102\r\na=rtpmap:104 H264/90000\r\na=rtcp-fb:104 goog-remb\r\na=rtcp-fb:104 transport-cc\r\na=rtcp-fb:104 ccm fir\r\na=rtcp-fb:104 nack\r\na=rtcp-fb:104 nack pli\r\na=fmtp:104 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42001f\r\na=rtpmap:105 rtx/90000\r\na=fmtp:105 apt=104\r\na=rtpmap:106 H264/90000\r\na=rtcp-fb:106 goog-remb\r\na=rtcp-fb:106 transport-cc\r\na=rtcp-fb:106 ccm fir\r\na=rtcp-fb:106 nack\r\na=rtcp-fb:106 nack pli\r\na=fmtp:106 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\na=rtpmap:107 rtx/90000\r\na=fmtp:107 apt=106\r\na=rtpmap:108 H264/90000\r\na=rtcp-fb:108 goog-remb\r\na=rtcp-fb:108 transport-cc\r\na=rtcp-fb:108 ccm fir\r\na=rtcp-fb:108 nack\r\na=rtcp-fb:108 nack pli\r\na=fmtp:108 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42e01f\r\na=rtpmap:109 rtx/90000\r\na=fmtp:109 apt=108\r\na=rtpmap:127 H264/90000\r\na=rtcp-fb:127 goog-remb\r\na=rtcp-fb:127 transport-cc\r\na=rtcp-fb:127 ccm fir\r\na=rtcp-fb:127 nack\r\na=rtcp-fb:127 nack pli\r\na=fmtp:127 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=4d001f\r\na=rtpmap:125 rtx/90000\r\na=fmtp:125 apt=127\r\na=rtpmap:39 H264/90000\r\na=rtcp-fb:39 goog-remb\r\na=rtcp-fb:39 transport-cc\r\na=rtcp-fb:39 ccm fir\r\na=rtcp-fb:39 nack\r\na=rtcp-fb:39 nack pli\r\na=fmtp:39 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=4d001f\r\na=rtpmap:40 rtx/90000\r\na=fmtp:40 apt=39\r\na=rtpmap:45 AV1/90000\r\na=rtcp-fb:45 goog-remb\r\na=rtcp-fb:45 transport-cc\r\na=rtcp-fb:45 ccm fir\r\na=rtcp-fb:45 nack\r\na=rtcp-fb:45 nack pli\r\na=fmtp:45 level-idx=5;profile=0;tier=0\r\na=rtpmap:46 rtx/90000\r\na=fmtp:46 apt=45\r\na=rtpmap:98 VP9/90000\r\na=rtcp-fb:98 goog-remb\r\na=rtcp-fb:98 transport-cc\r\na=rtcp-fb:98 ccm fir\r\na=rtcp-fb:98 nack\r\na=rtcp-fb:98 nack pli\r\na=fmtp:98 profile-id=0\r\na=rtpmap:99 rtx/90000\r\na=fmtp:99 apt=98\r\na=rtpmap:100 VP9/90000\r\na=rtcp-fb:100 goog-remb\r\na=rtcp-fb:100 transport-cc\r\na=rtcp-fb:100 ccm fir\r\na=rtcp-fb:100 nack\r\na=rtcp-fb:100 nack pli\r\na=fmtp:100 profile-id=2\r\na=rtpmap:101 rtx/90000\r\na=fmtp:101 apt=100\r\na=rtpmap:112 H264/90000\r\na=rtcp-fb:112 goog-remb\r\na=rtcp-fb:112 transport-cc\r\na=rtcp-fb:112 ccm fir\r\na=rtcp-fb:112 nack\r\na=rtcp-fb:112 nack pli\r\na=fmtp:112 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=64001f\r\na=rtpmap:113 rtx/90000\r\na=fmtp:113 apt=112\r\na=rtpmap:116 red/90000\r\na=rtpmap:117 rtx/90000\r\na=fmtp:117 apt=116\r\na=rtpmap:118 ulpfec/90000\r\na=ssrc-group:FID 583334944 2876421606\r\na=ssrc:583334944 cname:MxV7vls3AO3u1lWD\r\na=ssrc:583334944 msid:d15c6979-87f7-4177-b082-e54548148e46 31e24686-c6d8-4ca8-aab0-12e6f829fe23\r\na=ssrc:2876421606 cname:MxV7vls3AO3u1lWD\r\na=ssrc:2876421606 msid:d15c6979-87f7-4177-b082-e54548148e46 31e24686-c6d8-4ca8-aab0-12e6f829fe23\r\n",
        "type": "offer"
    }
}


8. handleOffer
async function handleOffer(offer) {
  if (pc) {
    console.error('existing peerconnection');
    return;
  }
  await createPeerConnection();
  await pc.setRemoteDescription(offer);
  console.log('æ¥æ”¶offer setRemoteDescription');

  const answer = await pc.createAnswer();
  signaling.postMessage({type: 'answer', sdp: answer.sdp});
  console.log('åˆ›å»ºanswer, å‘å¯¹ç«¯è¿”å›è‡ªå·±çš„sdpä¿¡æ¯');
  await pc.setLocalDescription(answer);
}
1. ï¼ˆç”±äºTCPçš„é¡ºåºæ€§ï¼Œä¸€å®šæ˜¯å…ˆå¤„ç†offerï¼Œå†å¤„ç†UDPï¼‰
2. ä¸ä¸Šé¢createOfferçš„æµç¨‹ç±»ä¼¼ã€‚ä½†æ˜¯å½“å‰å®¢æˆ·ç«¯ä½¿ç”¨setRemoteDescriptionæ¥æ”¶å¯¹ç«¯ä¼ è¾“çš„offerï¼Œç„¶ååˆ›å»ºanswerï¼ˆä¸offerçš„jsonæ ¼å¼ä¸€è‡´ï¼Œéƒ½æ˜¯ä¼ SDPï¼Œåªæ˜¯typeå­—æ®µå˜æˆäº†answer ï¼‰è¿”å›ç»™å¯¹ç«¯ã€‚
3. pc.setLocalDescription(answer)ä¹‹åä¾ç„¶æ‰§è¡Œcandidateçš„äº¤æ¢ã€‚
[å›¾ç‰‡]

9. handleAnswer
async function handleAnswer(answer) {
  if (!pc) {
    console.error('no peerconnection');
    return;
  }
  await pc.setRemoteDescription(answer);
}
1. ä¸handleOfferç›®çš„ä¸€è‡´ï¼Œè®°å½•å¯¹ç«¯çš„SDPä¿¡æ¯ã€‚ä½†æ˜¯ä¸éœ€è¦å†æ‰§è¡Œonicecandidateç»‘å®šçš„å›è°ƒå‡½æ•°äº†ï¼Œå› ä¸ºæ²¡æœ‰setLocalDescription(),åªéœ€è¦åœ¨handleCandidate()ä¸­å¤„ç†å¯¹ç«¯çš„candidateä¿¡æ¯ï¼ˆip & portï¼‰å³å¯ã€‚

10. handleCandidate
async function handleCandidate(candidate) {
  if (!pc) {
    console.error('no peerconnection');
    return;
  }
  if (!candidate.candidate) {
    await pc.addIceCandidate(null);
  } else {
    await pc.addIceCandidate(candidate);
  }
}
1. è¿™é‡Œçš„é€»è¾‘åªè´Ÿè´£å°†å¯¹ç«¯ä¼ æ¥çš„candidateè®°å½•ä¸‹æ¥ã€‚
2. æ³¨æ„âš ï¸ï¼šcandidateæ¶ˆæ¯çš„å‘é€ç”±onicecandidateç»‘å®šçš„å›è°ƒå‡½æ•°æ‰§è¡Œï¼Œå½“å‰å®¢æˆ·ç«¯ä¼šå‘å¯¹ç«¯å‘é€å¤šä¸ªcandidateä¿¡æ¯ã€‚æ‰€æœ‰handleCandidate()ä¼šå°†å¤šä¸ªcandidateéƒ½ä¿å­˜ä¸‹æ¥ï¼Œç„¶åæœ‰ICEæ¡†æ¶é€‰æ‹©æœ€åˆé€‚çš„candidate

11. å¤šä¸ªcandidate
[å›¾ç‰‡]

1. æˆ‘ä»¬å¯ä»¥æœ‰å¤šä¸ªSTUN/TURNæœåŠ¡å™¨ã€‚ICEæ¡†æ¶ä¼šè¿›è¡Œå¤šæ¬¡è°ƒç”¨ï¼Œå¹¶å°†å¾—åˆ°çš„candidateå‘é€ç»™å¯¹ç«¯ã€‚
2. å­—æ®µè§£é‡Š
  1. Time: ç”Ÿæˆå€™é€‰è€…çš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
  2. Type: å€™é€‰è€…çš„ç±»å‹ã€‚
    - host: æœ¬åœ°ä¸»æœºå€™é€‰è€…ï¼Œè¡¨ç¤ºç›´æ¥ä»æœ¬åœ°ç½‘ç»œæ¥å£è·å–çš„å€™é€‰è€…ã€‚
    - srflx: æœåŠ¡å™¨åå°„å€™é€‰è€…ï¼ˆServer Reflexiveï¼‰ï¼Œé€šè¿‡STUNæœåŠ¡å™¨è·å–çš„å€™é€‰è€…ï¼Œè¡¨ç¤ºNATåçš„å…¬å…±IPåœ°å€ã€‚
    - relay: ä¸­ç»§å€™é€‰è€…ï¼Œé€šè¿‡TURNæœåŠ¡å™¨è·å–çš„å€™é€‰è€…ï¼Œç”¨äºç©¿è¶ŠNATå’Œé˜²ç«å¢™ã€‚
  3. Foundation: å€™é€‰è€…çš„åŸºç¡€æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„å€™é€‰è€…ã€‚
  4. Protocol: ä½¿ç”¨çš„åè®®ï¼Œé€šå¸¸æ˜¯udpæˆ–tcpã€‚
  5. Address: å€™é€‰è€…çš„IPåœ°å€ã€‚
  6. Port: å€™é€‰è€…çš„ç«¯å£å·ã€‚
  7. Priority: å€™é€‰è€…çš„ä¼˜å…ˆçº§ï¼Œæ ¼å¼ä¸º<type preference> | <local preference> | <component ID>ã€‚
  8. URL (if present): å¦‚æœæ˜¯srflxæˆ–relayå€™é€‰è€…ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºSTUNæˆ–TURNæœåŠ¡å™¨çš„URLã€‚
  9. relayProtocol (if present): å¦‚æœæ˜¯relayå€™é€‰è€…ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä¸­ç»§åè®®ã€‚

12. P2Pçš„Sampleæ–‡ä»¶
æš‚æ—¶æ— æ³•åœ¨é£ä¹¦æ–‡æ¡£å¤–å±•ç¤ºæ­¤å†…å®¹
æš‚æ—¶æ— æ³•åœ¨é£ä¹¦æ–‡æ¡£å¤–å±•ç¤ºæ­¤å†…å®¹
æš‚æ—¶æ— æ³•åœ¨é£ä¹¦æ–‡æ¡£å¤–å±•ç¤ºæ­¤å†…å®¹


æ³¨æ„ï¼š
1. navigator.mediaDevices.getUserMediaè·å–åª’ä½“æµçš„æ—¶å€™éœ€è¦ä¿è¯æ˜¯httpsæˆ–è€…localhostè®¿é—®ï¼Œå¦åˆ™ä¸è¡Œ
2. ç„¶åç”±äºä½¿ç”¨äº†httpsï¼Œé‚£ä¹ˆä¿¡ä»¤æœåŠ¡å™¨ï¼ˆWebSocketï¼‰ä¹Ÿè¦æ˜¯wssçš„å½¢å¼ï¼ˆéœ€è¦åŠ å…¥SSLè®¤è¯ï¼‰
